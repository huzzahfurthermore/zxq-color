<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png"
		href="https://support.content.office.net/en-us/media/88a91cba-a9e9-48cb-9a93-6d9d2f7b0197.png">
	<title>Sindome Art Colorizer</title>
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Code+Pro|Quantico:400,400italic,700">
	<style>
.color { display: inline-block; margin-right: 10px; margin-bottom: 5px; width: 50px; height: 20px; border-right: 1px solid #ffffff; border-left: 1px solid #fff; cursor: pointer; }
@media only screen and (max-width: 999px) { .color { width: 25px; } }
@media only screen and (max-width: 699px) { .color { width: 20px; } }
body { background-color: black; color: #aaa; font-family: "Source Code Pro"; }
#editor-container { position: relative; width: 100%; height: 150px; margin-bottom: 15px; }
#editor-container, #textInput, #highlightLayer {}
#textInput, #highlightLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 5px; font-family: "Source Code Pro", monospace; font-size: 14px; line-height: 1.25; background-color: transparent; color: #aaa; white-space: pre-wrap; border: 1px solid #ccc; overflow: scroll; box-sizing: border-box; }
#textInput { z-index: 1; color: transparent; background-color: transparent; caret-color: #aaa; overflow-wrap: anywhere;}
#highlightLayer { z-index: 0; pointer-events: none; overflow-wrap: anywhere;}
textarea { resize: none; }
.highlight { color: #696969; }
.highlightNormal { color: #3a3a3a; }
.footer { position: relative; right: 10px; text-align: right; width: 100%; }
a { color: #aaa; }
	</style>
</head>

<body onbeforeunload="return myFunction()">
	<div id="colorPalette"></div>
	<div id="editor-container">
		<textarea id="textInput" placeholder="Enter text to be recolored..." spellcheck="true"
			oninput="updateHighlight(); updateOutput();"></textarea>
		<div id="highlightLayer"></div>
	</div>
	<div id="output">Colored text will appear here</div>
	<br><br><div class="footer">Ensure you close all tags with '%normal' before changing colors ⚜ <a href="/alt">No textbox highlighting</a> ⚜ <a href="/gradient">Gradient Maker</a></div>

	<script>
	  function myFunction() { return "Input is not saved."; }
		const colorDict = ["#ccc","#000000","#800000","#008000","#808000","#000080","#800080","#008080","#c0c0c0","#808080","#ff0000","#00ff00","#ffff00","#0000ff","#ff00ff","#00ffff","#ffffff","#000000","#00005f","#000087","#0000af","#0000d7","#0000ff","#005f00","#005f5f","#005f87","#005faf","#005fd7","#005fff","#008700","#00875f","#008787","#0087af","#0087d7","#0087ff","#00af00","#00af5f","#00af87","#00afaf","#00afd7","#00afff","#00d700","#00d75f","#00d787","#00d7af","#00d7d7","#00d7ff","#00ff00","#00ff5f","#00ff87","#00ffaf","#00ffd7","#00ffff","#5f0000","#5f005f","#5f0087","#5f00af","#5f00d7","#5f00ff","#5f5f00","#5f5f5f","#5f5f87","#5f5faf","#5f5fd7","#5f5fff","#5f8700","#5f875f","#5f8787","#5f87af","#5f87d7","#5f87ff","#5faf00","#5faf5f","#5faf87","#5fafaf","#5fafd7","#5fafff","#5fd700","#5fd75f","#5fd787","#5fd7af","#5fd7d7","#5fd7ff","#5fff00","#5fff5f","#5fff87","#5fffaf","#5fffd7","#5fffff","#870000","#87005f","#870087","#8700af","#8700d7","#8700ff","#875f00","#875f5f","#875f87","#875faf","#875fd7","#875fff","#878700","#87875f","#878787","#8787af","#8787d7","#8787ff","#87af00","#87af5f","#87af87","#87afaf","#87afd7","#87afff","#87d700","#87d75f","#87d787","#87d7af","#87d7d7","#87d7ff","#87ff00","#87ff5f","#87ff87","#87ffaf","#87ffd7","#87ffff","#af0000","#af005f","#af0087","#af00af","#af00d7","#af00ff","#af5f00","#af5f5f","#af5f87","#af5faf","#af5fd7","#af5fff","#af8700","#af875f","#af8787","#af87af","#af87d7","#af87ff","#afaf00","#afaf5f","#afaf87","#afafaf","#afafd7","#afafff","#afd700","#afd75f","#afd787","#afd7af","#afd7d7","#afd7ff","#afff00","#afff5f","#afff87","#afffaf","#afffd7","#afffff","#d70000","#d7005f","#d70087","#d700af","#d700d7","#d700ff","#d75f00","#d75f5f","#d75f87","#d75faf","#d75fd7","#d75fff","#d78700","#d7875f","#d78787","#d787af","#d787d7","#d787ff","#d7af00","#d7af5f","#d7af87","#d7afaf","#d7afd7","#d7afff","#d7d700","#d7d75f","#d7d787","#d7d7af","#d7d7d7","#d7d7ff","#d7ff00","#d7ff5f","#d7ff87","#d7ffaf","#d7ffd7","#d7ffff","#ff0000","#ff005f","#ff0087","#ff00af","#ff00d7","#ff00ff","#ff5f00","#ff5f5f","#ff5f87","#ff5faf","#ff5fd7","#ff5fff","#ff8700","#ff875f","#ff8787","#ff87af","#ff87d7","#ff87ff","#ffaf00","#ffaf5f","#ffaf87","#ffafaf","#ffafd7","#ffafff","#ffd700","#ffd75f","#ffd787","#ffd7af","#ffd7d7","#ffd7ff","#ffff00","#ffff5f","#ffff87","#ffffaf","#ffffd7","#ffffff","#080808","#121212","#1c1c1c","#262626","#303030","#3a3a3a","#444444","#4e4e4e","#585858","#626262","#6c6c6c","#767676","#808080","#8a8a8a","#949494","#9e9e9e","#a8a8a8","#b2b2b2","#bcbcbc","#c6c6c6","#d0d0d0","#dadada","#e4e4e4","#eeeeee"];

		const colorPalette = document.getElementById('colorPalette');
		for (const code in colorDict) {
		    if (code == 0) { } else {
			const colorName = colorDict[code];
			const colorDiv = document.createElement('div');
			colorDiv.classList.add('color');
			colorDiv.style.backgroundColor = colorName;
			colorDiv.title = code;
			colorDiv.addEventListener('click', function () {
				applyColor(colorName, parseInt(code));
			});
			colorPalette.appendChild(colorDiv);
		    }
		}

		const textInput = document.getElementById('textInput');
		const highlightLayer = document.getElementById('highlightLayer');

		textInput.addEventListener('scroll', function () {
			// console.log(highlightLayer.scrollTop, textInput.scrollTop);
			highlightLayer.scrollTop = textInput.scrollTop;
			textInput.scrollTop = highlightLayer.scrollTop;
			updateOutput();
		});

		function updateHighlight() {
			const text = textInput.value;
			const highlighted = text.replace(/(%\([^)]+\)|%bright|%normal)/g, '<span class="highlight">$1</span>')
				.replace(/(%normal)/g, '<span class="highlightNormal">$1</span>');
			highlightLayer.innerHTML = highlighted;
			updateOutput();
		}

		function applyColor(color, code) {
			const selectionStart = textInput.selectionStart;
			const selectionEnd = textInput.selectionEnd;
			const text = textInput.value;
			let newText;

			if (selectionStart !== selectionEnd) {
				const selectedText = text.slice(selectionStart, selectionEnd);
				const numberRegex = /^\d+$/;

				if (numberRegex.test(selectedText)) {
					// If the selected text is a number, replace it with the new color code
					if (code == 16 || code == 232) { newText = text.slice(0, selectionStart) + `%bright` + text.slice(selectionEnd);
					} else { newText = text.slice(0, selectionStart) + code + text.slice(selectionEnd); }
				} else {
					// If it's not a number, wrap the selected text with the color code
					if (code == 16 || code == 232) { newText = text.slice(0, selectionStart) + `%bright${selectedText}%normal` + text.slice(selectionEnd);
					} else { newText = text.slice(0, selectionStart) + `%(${code})${selectedText}%normal` + text.slice(selectionEnd); }
				}
			} else {
				// If no text is selected, insert the color code at the cursor position
				if (code == 16 || code == 232) { newText = text.slice(0, selectionStart) + `%bright%normal` + text.slice(selectionStart);
				} else { newText = text.slice(0, selectionStart) + `%(${code})%normal` + text.slice(selectionStart); }
			}

			textInput.value = newText;
			updateHighlight();

			// Set cursor position after the inserted color code
			const newCursorPosition = selectionStart + (code == 16 || code == 232 ? 7 : code.toString().length + 3);
			textInput.setSelectionRange(newCursorPosition, newCursorPosition);
			textInput.focus();
		}
      const regex = /(\%\(\d{1,3}\))|(\%normal)|(\%bright)|([\s\S])/g;

      function renderXterm(text) {
        let output = "";
        let currentColor = "#aaa";
        let lines = [];
        let currentLine = "";
        text.replace(regex, (match, colorCode, normal, bright, textContent) => {
          if (colorCode) {
            if (colorCode.startsWith("%(")) {
              const lily = colorCode.slice(2, -1); 
              const idx = parseInt(lily);
              currentColor = xtermToRgbHex(idx);
            } 
          } else if (normal) { currentLine += "";
          } else if (bright) { currentLine += ""; currentColor = "#ffffff";
          } else if (textContent) {
            if (textContent === "\n") {
              lines.push({ content: currentLine });
              currentLine = "";
            } else {
              if (/\s/.test(textContent)) { currentLine += escapeHtml(textContent);
              } else { currentLine += `<span style="color: ${currentColor}">${escapeHtml(textContent)}</span>`; }
            }
          }
        });
        
        // Add the last line if it has content
        if (currentLine) {lines.push({ content: currentLine });}
        
        // Build the output with line character counts
        lines.forEach(line => {
            if (line.content == "") {output += `<div style="position: relative;"><span> </span></div>`;
            } else {output += `<div style="position: relative;">${line.content}</div>`;}
        });
        
        return output;
      }
      
      function updateOutput(coloredText) {
        // Use colored text if provided, otherwise get from copyable output
        const textToRender = coloredText || document.getElementById("textInput").value;
        document.getElementById("output").innerHTML = renderXterm(textToRender);
      }
      
      function xtermToRgbHex(colorIndex) {
          return colorDict[colorIndex];
      }
      function escapeHtml(text) {
        const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;", };
        return text.replace(/[&<>"']/g, function (m) {return map[m];});
      }
      </script>
  </body>
</html>
